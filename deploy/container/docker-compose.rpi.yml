version: "3.3"

services:
  rusty-pinch-telegram:
    image: ${RUSTY_PINCH_IMAGE:-ghcr.io/fred-vu/rusty-pinch:latest}
    platform: linux/arm64
    env_file:
      - ./rusty-pinch.rpi.env
    command: ["channels", "telegram"]
    volumes:
      - ./data:/var/lib/rusty-pinch/data
      - ./workspace:/var/lib/rusty-pinch/workspace
      - ./skills:/var/lib/rusty-pinch/workspace/skills
      - ./codex-home:/var/lib/rusty-pinch/codex-home
    healthcheck:
      test: ["CMD", "rusty-pinch", "doctor"]
      interval: 60s
      timeout: 10s
      retries: 3
    labels:
      com.centurylinklabs.watchtower.enable: "true"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    restart: unless-stopped

  rusty-pinch-whatsapp:
    image: ${RUSTY_PINCH_IMAGE:-ghcr.io/fred-vu/rusty-pinch:latest}
    platform: linux/arm64
    env_file:
      - ./rusty-pinch.rpi.env
    command: ["channels", "whatsapp"]
    volumes:
      - ./data:/var/lib/rusty-pinch/data
      - ./workspace:/var/lib/rusty-pinch/workspace
      - ./skills:/var/lib/rusty-pinch/workspace/skills
      - ./codex-home:/var/lib/rusty-pinch/codex-home
    healthcheck:
      test: ["CMD", "rusty-pinch", "doctor"]
      interval: 60s
      timeout: 10s
      retries: 3
    labels:
      com.centurylinklabs.watchtower.enable: "true"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    restart: unless-stopped

  watchtower:
    image: containrrr/watchtower:1.7.1
    command:
      - --label-enable
      - --rolling-restart
      - --cleanup
      - --interval
      - ${WATCHTOWER_POLL_INTERVAL_SECS:-300}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
